#!/usr/bin/env ruby
# vi:syntax=ruby

#sync output
$stdout.sync = true

build_path = ARGV[0]
cache_path = ARGV[1]

puts "Installing Dotnet"

puts "Install libunwind && libgettextpo"
system("cp /tmp/buildpacks/*/ldconfig_wrapper.sh #{build_path}/")
system("mkdir -p #{build_path}/vendor/libunwind")
Dir.chdir("#{build_path}/vendor/libunwind") do
  system("tar zxvf /tmp/buildpacks/*/libunwind.tgz")
end
system("mkdir -p #{build_path}/vendor/libgettextpo")
Dir.chdir("#{build_path}/vendor/libgettextpo") do
  system("tar zxvf /tmp/buildpacks/*/libgettextpo.tgz")
end

puts("#{build_path}/vendor")
system('mkdir', '-p', "#{build_path}/vendor")
system("bash -c 'export HOME=#{build_path} ; source #{build_path}/ldconfig_wrapper.sh ; curl -sSk https://raw.githubusercontent.com/dotnet/cli/rel/1.0.0/scripts/obtain/dotnet-install.sh | bash /dev/stdin --version 1.0.0-preview1-002702 --install-dir #{build_path}/vendor/dotnet'")

Dir.chdir(build_path)
puts "Restoring packages"
system("bash -c 'export HOME=#{build_path} ; source #{build_path}/ldconfig_wrapper.sh ; #{build_path}/vendor/dotnet/dotnet restore")

puts "Building"
system("bash -c 'export HOME=#{build_path} ; source #{build_path}/ldconfig_wrapper.sh ; #{build_path}/vendor/dotnet/dotnet build")

puts "Publishing"
system("bash -c 'export HOME=#{build_path} ; source #{build_path}/ldconfig_wrapper.sh ; #{build_path}/vendor/dotnet/dotnet publish")

puts "Directory Tree"
puts "BuildPath: #{build_path}"
system("find #{build_path}")
